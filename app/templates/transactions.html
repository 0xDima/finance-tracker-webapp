<!-- app/templates/transactions.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transactions</title>

  <link rel="stylesheet" href="{{ url_for('static', path='css/transactions.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
{% set qp = request.query_params %}
{% set scope_label = (qp.get('start_date', '') ~ ' → ' ~ qp.get('end_date', '')) if (qp.get('start_date', '') and qp.get('end_date', '')) else (current_month if current_month else 'All') %}

<div class="tx-page page-fade" data-page>
  <header class="tx-topbar" data-topbar>
    <div class="tx-topbar-inner">
      <div class="tx-topbar-left">
        <div class="tx-titlewrap">
          <h1 class="tx-title">Transactions</h1>
          <div class="tx-subtitle" title="{{ scope_label }}">{{ scope_label }}</div>
        </div>
      </div>

      <div class="tx-topbar-right">
        <a class="btn btn-ghost topbar-btn" href="/dashboard" aria-label="Go to dashboard">← Dashboard</a>
      </div>
    </div>
  </header>

  <main class="tx-shell">
    <!-- Filters (card) -->
    <section class="card tx-card tx-card-filters" aria-label="Filters">
      <div class="card-head">
        <div class="card-head-left">
          <div class="card-title">Filters</div>
          <div class="card-subtitle">Refine results</div>
        </div>

        <div class="card-head-right">
          <button type="button" class="icon-btn tx-filters-toggle" data-filters-toggle aria-expanded="true" aria-controls="filters_body">
            <span class="icon-btn-text">Filters</span>
            <span class="icon-btn-icon" aria-hidden="true">▾</span>
          </button>
        </div>
      </div>

      <form method="get" action="/transactions" class="filters" aria-label="Transaction filters">
        <div class="filters-body" id="filters_body" data-filters-body>
          <div class="filters-grid">
            <section class="filter-block filter-span-2" aria-label="Date range filter">
              <div class="filter-label-row">
                <label class="filter-label" for="date_range">Date range</label>

                <div class="chips-row" role="group" aria-label="Quick ranges">
                  <button type="button" class="chip-btn" data-preset="last-month">Last month</button>
                  <button type="button" class="chip-btn" data-preset="ytd">YTD</button>
                  <button type="button" class="chip-btn" data-preset="all">All</button>
                </div>
              </div>

              <input
                type="text"
                id="date_range"
                class="text-input"
                placeholder="Select date range"
                autocomplete="off"
                inputmode="none"
                aria-describedby="date_range_help"
              />

              <div class="date-fallback" data-date-fallback>
                <div class="date-grid">
                  <div class="date-field">
                    <label class="mini-label" for="start_date">Start</label>
                    <input
                      type="date"
                      id="start_date"
                      name="start_date"
                      value="{{ qp.get('start_date', '') }}"
                      class="text-input"
                    />
                  </div>
                  <div class="date-field">
                    <label class="mini-label" for="end_date">End</label>
                    <input
                      type="date"
                      id="end_date"
                      name="end_date"
                      value="{{ qp.get('end_date', '') }}"
                      class="text-input"
                    />
                  </div>
                </div>
              </div>
            </section>

            <section class="filter-block" aria-label="Search filter">
              <label class="filter-label" for="search">Search</label>
              <input
                type="text"
                id="search"
                name="search"
                class="text-input"
                placeholder="Description or notes"
                value="{{ qp.get('search', '') }}"
              />
            </section>

            <section class="filter-block" aria-label="Amount range filter">
              <label class="filter-label">Amount (EUR)</label>
              <div class="amount-grid">
                <div class="money-field">
                  <label class="mini-label" for="min_amount">Min</label>
                  <div class="money-input">
                    <span class="money-prefix" aria-hidden="true">€</span>
                    <input
                      type="number"
                      step="0.01"
                      inputmode="decimal"
                      id="min_amount"
                      name="min_amount"
                      class="text-input"
                      value="{{ qp.get('min_amount', '') }}"
                      placeholder="0.00"
                    />
                  </div>
                </div>

                <div class="money-field">
                  <label class="mini-label" for="max_amount">Max</label>
                  <div class="money-input">
                    <span class="money-prefix" aria-hidden="true">€</span>
                    <input
                      type="number"
                      step="0.01"
                      inputmode="decimal"
                      id="max_amount"
                      name="max_amount"
                      class="text-input"
                      value="{{ qp.get('max_amount', '') }}"
                      placeholder="0.00"
                    />
                  </div>
                </div>
              </div>
            </section>

            <section class="filter-block" aria-label="Category filter">
              <label class="filter-label" for="category_search">Category</label>

              <details class="multi-select" data-multiselect="category">
                <summary class="multi-summary" aria-controls="category_panel">
                  <span class="multi-summary-title">Select categories</span>
                  <span class="multi-summary-meta" aria-hidden="true" data-multi-meta="category">
                    {% if selected_categories and selected_categories|length > 0 %}
                      {{ selected_categories|length }} selected
                    {% else %}
                      Any
                    {% endif %}
                  </span>
                </summary>

                <div class="multi-panel" id="category_panel" role="group" aria-label="Category selection">
                  <div class="multi-top">
                    <input
                      type="text"
                      id="category_search"
                      class="text-input"
                      placeholder="Search categories..."
                      autocomplete="off"
                      data-multi-search
                    />
                  </div>

                  {% if selected_categories and selected_categories|length > 0 %}
                    <div class="chips" aria-label="Selected categories">
                      {% for c in selected_categories %}
                        <button type="button" class="chip" data-chip-value="{{ c }}" data-chip-for="category">
                          {{ c }} <span class="chip-x" aria-hidden="true">×</span>
                        </button>
                      {% endfor %}
                    </div>
                  {% endif %}

                  <div class="multi-list" role="listbox" aria-label="Category options">
                    {% for cat in all_categories %}
                      <label class="check-row" data-multi-item>
                        <input
                          type="checkbox"
                          name="category"
                          value="{{ cat }}"
                          {% if cat in selected_categories %}checked{% endif %}
                        />
                        <span class="check-text">{{ cat }}</span>
                      </label>
                    {% endfor %}
                  </div>

                  <div class="multi-footer" aria-label="Category actions">
                    <button type="button" class="btn btn-ghost btn-small" data-clear-group="category">Clear</button>
                    <button type="submit" class="btn btn-primary btn-small">Apply</button>
                  </div>
                </div>
              </details>
            </section>

            <section class="filter-block" aria-label="Account filter">
              <label class="filter-label" for="account_search">Account</label>

              <details class="multi-select" data-multiselect="account">
                <summary class="multi-summary" aria-controls="account_panel">
                  <span class="multi-summary-title">Select accounts</span>
                  <span class="multi-summary-meta" aria-hidden="true" data-multi-meta="account">
                    {% if selected_accounts and selected_accounts|length > 0 %}
                      {{ selected_accounts|length }} selected
                    {% else %}
                      Any
                    {% endif %}
                  </span>
                </summary>

                <div class="multi-panel" id="account_panel" role="group" aria-label="Account selection">
                  <div class="multi-top">
                    <input
                      type="text"
                      id="account_search"
                      class="text-input"
                      placeholder="Search accounts..."
                      autocomplete="off"
                      data-multi-search
                    />
                  </div>

                  {% if selected_accounts and selected_accounts|length > 0 %}
                    <div class="chips" aria-label="Selected accounts">
                      {% for a in selected_accounts %}
                        <button type="button" class="chip" data-chip-value="{{ a }}" data-chip-for="account">
                          {{ a }} <span class="chip-x" aria-hidden="true">×</span>
                        </button>
                      {% endfor %}
                    </div>
                  {% endif %}

                  <div class="multi-list" role="listbox" aria-label="Account options">
                    {% for acc in all_accounts %}
                      <label class="check-row" data-multi-item>
                        <input
                          type="checkbox"
                          name="account"
                          value="{{ acc }}"
                          {% if acc in selected_accounts %}checked{% endif %}
                        />
                        <span class="check-text">{{ acc }}</span>
                      </label>
                    {% endfor %}

                    {% if "None" not in all_accounts %}
                      <label class="check-row" data-multi-item>
                        <input
                          type="checkbox"
                          name="account"
                          value="None"
                          {% if "None" in selected_accounts %}checked{% endif %}
                        />
                        <span class="check-text">None</span>
                      </label>
                    {% endif %}
                  </div>

                  <div class="multi-footer" aria-label="Account actions">
                    <button type="button" class="btn btn-ghost btn-small" data-clear-group="account">Clear</button>
                    <button type="submit" class="btn btn-primary btn-small">Apply</button>
                  </div>
                </div>
              </details>
            </section>

            <section class="filter-actions" aria-label="Filter actions">
              <button type="submit" class="btn btn-primary">Apply</button>
              <a href="/transactions" class="btn btn-ghost">Reset</a>
            </section>
          </div>
        </div>
      </form>
    </section>

    <section class="card tx-card" aria-label="Results">
      <div class="card-head">
        <div class="card-head-left">
          <div class="card-title">Results</div>
          <div class="card-subtitle">Sorted by {{ sort }} ({{ dir }})</div>
        </div>

        <div class="card-head-right">
          <div class="seg">
            <button type="button" class="seg-btn" data-expand-all>Expand all</button>
            <button type="button" class="seg-btn" data-collapse-all>Collapse all</button>
          </div>
        </div>
      </div>

      {% if transactions|length == 0 %}
        <div class="empty">
          <div class="empty-icon" aria-hidden="true">∅</div>
          <div class="empty-title">No transactions</div>
          <div class="empty-sub">Try adjusting filters or date range.</div>
        </div>
      {% else %}
        <div class="table-scroll" data-table-scroll>
          <table class="transactions-table" data-tx-table>
            <thead>
              <tr>
                <th class="col-date sticky">
                  <a class="sort-link" href="{{ date_sort_url }}">
                    Date
                    {% if sort == 'date' %}
                      <span class="sort-indicator" aria-label="Sorted {{ dir }}">{{ "↑" if dir == "asc" else "↓" }}</span>
                    {% endif %}
                  </a>
                </th>
                <th class="col-desc sticky">Description</th>
                <th class="col-cat sticky">Category</th>
                <th class="col-amt sticky">
                  <a class="sort-link sort-right" href="{{ amount_sort_url }}">
                    Amount
                    {% if sort == 'amount' %}
                      <span class="sort-indicator" aria-label="Sorted {{ dir }}">{{ "↑" if dir == "asc" else "↓" }}</span>
                    {% endif %}
                  </a>
                </th>
              </tr>
            </thead>

            <tbody>
              {% for tx in transactions %}
              <tr class="row tx-row" data-tx-row>
                <td class="date-cell mono" data-date-cell>{{ tx.date }}</td>

                <td class="desc-cell">
                  <div class="desc-top">
                    <span class="desc-text">{{ tx.description }}</span>
                  </div>

                  <details class="row-details" data-row-details>
                    <summary class="row-details-summary">
                      Details <span class="chev" aria-hidden="true">▾</span>
                    </summary>

                    <div class="details-card">
                      <div class="details-card-header">
                        <span class="details-label mono">TxID: {{ tx.id }}</span>
                        <span class="details-amount-pill mono {% if tx.amount_eur < 0 %}details-amount-negative{% else %}details-amount-positive{% endif %}">
                          {% if tx.amount_eur < 0 %}
                            {{ tx.amount_eur }} €
                          {% else %}
                            +{{ tx.amount_eur }} €
                          {% endif %}
                        </span>
                      </div>

                      <ul class="details-list">
                        <li><span>Account:</span> {{ tx.account_name }}</li>
                        <li><span>Date:</span> {{ tx.date }}</li>
                        <li><span>Description:</span> {{ tx.description }}</li>
                        <li><span>Category:</span> {{ tx.category }}</li>
                          {% if tx.notes %}
                            <li><span>Note:</span> {{ tx.notes }}</li>
                          {% endif %}
                        <li><span>Original:</span> {{ tx.amount_original }} {{ tx.currency_original }}</li>
                        <li><span>EUR:</span> {{ tx.amount_eur }} €</li>
                      </ul>
                    </div>
                  </details>
                </td>

                <td class="cat-cell">
                  <span class="pill">{{ tx.category }}</span>
                </td>

                <td class="amount-cell mono">
                  {% if tx.amount_eur < 0 %}
                    <span class="amount amount-negative mono">{{ tx.amount_eur }} €</span>
                  {% else %}
                    <span class="amount amount-positive mono">+{{ tx.amount_eur }} €</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="table-summary" role="region" aria-label="Summary">
          <div class="table-summary-item">
            <span class="table-summary-label">Count</span>
            <span class="table-summary-value mono">{{ transactions|length }}</span>
          </div>
          <div class="table-summary-divider" aria-hidden="true"></div>
          <div class="table-summary-item">
            <span class="table-summary-label">Income</span>
            <span class="table-summary-value summary-positive mono">€{{ "%.2f"|format(income_sum) }}</span>
          </div>
          <div class="table-summary-divider" aria-hidden="true"></div>
          <div class="table-summary-item">
            <span class="table-summary-label">Expenses</span>
            <span class="table-summary-value summary-negative mono">€{{ "%.2f"|format(expense_sum) }}</span>
          </div>
          <div class="table-summary-divider" aria-hidden="true"></div>
          <div class="table-summary-item">
            <span class="table-summary-label">Net</span>
            <span class="table-summary-value mono">€{{ "%.2f"|format(net_sum) }}</span>
          </div>
        </div>
      {% endif %}
    </section>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{{ url_for('static', path='js/transactions.js') }}" defer></script>
</body>
</html>