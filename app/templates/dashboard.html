<!-- app/templates/dashboard.html -->
<!-- Role: Dashboard Jinja2 template — renders the main overview page with month summary, status pills, spending-by-category chart + legend,
     and a “Top 10 Biggest Transactions” table. JSON data is embedded for dashboard.js to render Chart.js and deep-link into Transactions. -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="/static/css/dashboard.css" />
</head>
<body>
  <div class="app" id="app">
    <header class="topbar">
      <div class="topbar__left">
        <div class="topbar__title">Dashboard</div>
        <div class="topbar__subtitle">{{ month_label }}</div>
      </div>

      <!-- Primary navigation (active state uses request.url.path) -->
      <div class="topbar__center" aria-label="Primary navigation">
        <a class="navbtn {% if request and request.url.path.startswith('/upload') %}navbtn--active{% endif %}"
           href="/upload">
          Upload
        </a>
        <a class="navbtn {% if request and request.url.path.startswith('/transactions') %}navbtn--active{% endif %}"
           href="/transactions">
          Transactions
        </a>
      </div>

      <div class="topbar__right">
        <!-- Import status for the current month label -->
        <div class="pill pill--status {% if previous_month_imported %}pill--ok{% else %}pill--bad{% endif %}">
          <span class="pill__dot" aria-hidden="true"></span>
          <span class="pill__statusText">
            {% if previous_month_imported %}
              {{ month_label }} data is imported
            {% else %}
              {{ month_label }} data is not imported
            {% endif %}
          </span>
        </div>

        <div class="pill" aria-label="Net">
          <span class="pill__label">Net</span>
          <span class="pill__value">
            {% if net_eur >= 0 %}+{% endif %}{{ "%.2f"|format(net_eur) }} €
          </span>
        </div>
      </div>
    </header>

    <main class="content">
      <section class="hero">
        <div class="hero__chart card">
          <div class="card__head">
            <div class="card__title">Spending by Category</div>
            <div class="card__meta">Click a category to open Transactions</div>
          </div>

          <div class="donut">
            <div class="donut__canvas">
              <canvas id="spendingByCategoryChart" width="320" height="320" aria-label="Spending by category donut chart" role="img"></canvas>
              <div class="donut__center" aria-label="Total spent">
                <div class="donut__centerLabel">Total</div>
                <div class="donut__centerValue">−{{ "%.2f"|format(total_spent_eur) }} €</div>
              </div>
            </div>

            <div class="donut__legendWrap">
              <div class="legend" id="categoryLegend" aria-label="Category legend"></div>
            </div>
          </div>
        </div>

        <div class="hero__summary">
          <div class="summaryGrid">
            <div class="metric card metric--income">
              <div class="metric__label">Income</div>
              <div class="metric__value">+{{ "%.2f"|format(income_eur) }} €</div>
              <div class="metric__hint">{{ month_label }}</div>
            </div>

            <div class="metric card metric--expenses">
              <div class="metric__label">Expenses</div>
              <div class="metric__value">{{ "%.2f"|format(expenses_eur) }} €</div>
              <div class="metric__hint">{{ month_label }}</div>
            </div>

            <div class="metric card metric--net">
              <div class="metric__label">Net</div>
              <div class="metric__value">
                {% if net_eur >= 0 %}+{% endif %}{{ "%.2f"|format(net_eur) }} €
              </div>
              <div class="metric__hint">{{ month_label }}</div>
            </div>

            <div class="investmentsRow">
              <div class="card investment">
                <div class="card__head">
                  <div class="card__title">Investments</div>
                  <div class="card__meta">Snapshot</div>
                </div>
                <div class="investment__grid">
                  <div class="investment__item" role="group" aria-label="Stocks card">
                    <div class="investment__kicker">Stocks</div>
                    <div class="investment__value">—</div>
                    <div class="investment__sub">Positions • Performance</div>
                  </div>
                  <div class="investment__item" role="group" aria-label="Crypto card">
                    <div class="investment__kicker">Crypto</div>
                    <div class="investment__value">—</div>
                    <div class="investment__sub">Holdings • Volatility</div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <section class="lower">
        <div class="card tableCard">
          <div class="card__head tableCard__head">
            <div>
              <div class="card__title">Top 10 Biggest Transactions</div>
              <div class="card__meta">By absolute amount • {{ month_label }}</div>
            </div>

            <a class="btn btn--ghost"
               href="/transactions?start_date={{ month_start_iso }}&end_date={{ next_month_start_iso }}">
              See all monthly transactions
            </a>
          </div>

          <div class="tableCard__body">
            <div class="tableWrap" role="region" aria-label="Monthly transactions table">
              <table class="txTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Account</th>
                    <th>Category</th>
                    <th class="num">Amount (EUR)</th>
                  </tr>
                </thead>
                <tbody>
                  {% if recent_transactions and recent_transactions|length > 0 %}
                    {% for tx in recent_transactions %}
                      <tr>
                        <td>{{ tx.date.strftime("%b %d") }}</td>
                        <td>{{ tx.description or "—" }}</td>
                        <td>{{ tx.account_name or "—" }}</td>
                        <td>{{ tx.category or "Uncategorized" }}</td>
                        <td class="num">
                          {% if tx.amount_eur is not none %}
                            {% if tx.amount_eur >= 0 %}+{% endif %}{{ "%.2f"|format(tx.amount_eur) }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="5" style="color: rgba(255,255,255,.62); padding: 14px 12px;">
                        No transactions found for this month.
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <div class="tableHint">Tip: click a category in the legend above to jump to filtered Transactions.</div>
          </div>
        </div>
      </section>
    </main>

    <!-- Embedded JSON payload used by dashboard.js (Chart.js + clickable legend) -->
    <script id="spending-by-category-data" type="application/json">
      {{ spending_by_category | tojson }}
    </script>

    <!-- Embedded month range used to preserve the dashboard date window when linking to /transactions -->
    <script id="month-range-data" type="application/json">
      {{ {"start_date": month_start_iso, "end_date": next_month_start_iso} | tojson }}
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/dashboard.js"></script>
  </div>
</body>
</html>